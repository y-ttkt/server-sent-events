
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SSE Test</title>
    <style>
        body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 2rem; }
        pre { background: #111; color: #eee; padding: 1rem; border-radius: 8px; overflow: auto; }
        .log { white-space: pre-wrap; word-break: break-word; }
        .pill { display:inline-block; padding: .2rem .5rem; border-radius: 999px; background:#eee; margin-right:.5rem; }
    </style>
</head>
<body>
<h1>Server‑Sent Events — demo</h1>
<p>
    <span class="pill" id="state">CONNECTING</span>
    <button id="disconnect">disconnect</button>
    <button id="reconnect">reconnect</button>
</p>
<pre id="out" class="log"></pre>
<script>
    const out = document.getElementById('out');
    const stateEl = document.getElementById('state');
    const url = '/stream?retry=5000';
    let es = null;

    function log(kind, obj) {
        const line = `[${new Date().toISOString()}] ${kind}: ${typeof obj === 'string' ? obj : JSON.stringify(obj)}`;
        out.textContent += line + "\n";
        out.scrollTop = out.scrollHeight;
    }

    function readyStateText(n) {
        return n === 0 ? 'CONNECTING'
            : n === 1 ? 'OPEN'
                : 'CLOSED';
    }

    function connect() {
        if (es && es.readyState !== EventSource.CLOSED) return;
        es = new EventSource(url, { withCredentials: true });
        stateEl.textContent = readyStateText(es.readyState);

        es.onopen = () => {
            stateEl.textContent = readyStateText(es.readyState);
            log('open', 'connected');
        };

        es.onmessage = (e) => {
            log('message', e.data);
        };

        es.addEventListener('tick', (e) => {
            try {
                const data = JSON.parse(e.data);
                log('tick', data);
            } catch (err) {
                log('tick-parse-error', err.message);
            }
        });

        es.onerror = (e) => {
            stateEl.textContent = readyStateText(es.readyState);
            log('error', 'network/change or server closed');
        };
    }

    connect();

    document.getElementById('disconnect').onclick = () => {
        if (es) es.close();
        stateEl.textContent = 'CLOSED';
        log('client', 'closed connection');
    };
    document.getElementById('reconnect').onclick = () => {
        connect();
    };
</script>
</body>
</html>
